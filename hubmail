#!/usr/bin/env python3
"""hubmail: a tool to export GitHub issues and pull requests as email messages

Usage:
  hubmail (issue|pr) [options] USER REPO NUMBER

Options:
  -c, --comments         Include comments
  -f, --from             Include a line "From ... TIMESTAMP" in the MBOX data
                         before the message headers begin (Gmail-style MBOX)
  -w COLS, --wrap=COLS   Wrap lines of text to a certain number of columns
                         [default: 0]
"""
# SPDX-License-Identifier: LGPL-2.1-or-later

import sys
import os
import email.utils as eu
import textwrap
import itertools
import re

import requests
from docopt import docopt
from dateutil.parser import isoparse

try:
    from dotenv import load_dotenv
except ModuleNotFoundError:
    pass

def run_query(token, query):
    request = requests.post("https://api.github.com/graphql",
                            json={"query": query},
                            headers={"Authorization": f"Bearer {token}"})
    if request.status_code != 200:
        raise Exception(f"Fail with {request.status_code}\n{query}")
    result = request.json()

    if "errors" in result:
        raise Exception(result["errors"])
    else:
        return result

def get_issue(token, user, repo, number, options):
    query = f"""{{
    repository(owner:"{user}", name:"{repo}") {{
        issue(number:{number}) {{
            title,
            author {{
                login
            }},
            body,
            createdAt
            { '''
            comments(first:20) {
                nodes {
                    author {
                        login
                    },
                    body,
                    createdAt
                }
            }
            ''' if options['comments'] else '' }
        }}
    }}
    }}"""
    try:
        return run_query(token, query)["data"]["repository"]["issue"]
    except Exception as e:
        print(e, file=sys.stderr)
        sys.exit(1)

def get_pr(token, user, repo, number, options):
    query = f"""{{
    repository(owner:"{user}", name:"{repo}") {{
        pullRequest(number:{number}) {{
            url,
            { '''
            title,
            comments(first:20) {
                nodes {
                    author {
                        login
                    },
                    body,
                    createdAt
                }
            }
            ''' if options['comments'] else '' }
        }}
    }}
    }}"""
    try:
        return run_query(token, query)["data"]["repository"]["pullRequest"]
    except Exception as e:
        print(e, file=sys.stderr)
        sys.exit(1)

def get_user(token, login):
    query = f"""{{
    user(login:"{login}") {{
        login,
        name,
        email
    }}
    }}"""
    try:
        return run_query(token, query)["data"]["user"]
    except Exception as e:
        print(e, file=sys.stderr)
        sys.exit(1)

def fill(text, options, **kwargs):
    try:
        cols = int(options["wrap"])
    except ValueError:
        return text
    if cols <= 0:
        return text
    return textwrap.fill(
        text, cols, expand_tabs=False, replace_whitespace=False,
        drop_whitespace=False, break_long_words=False, break_on_hyphens=False,
        **kwargs
    )

def from_heading(heading="-", enable=True):
    return (f"From {heading} {eu.format_datetime(eu.localtime())}\n"
            if enable else "")

def format_email(name, address, timestamp, subject, body, options,
                 heading="-"):
    body = "\n".join(
        fill("\n".join(g), options, subsequent_indent=match.group(0)
             if match and match.group(0).startswith(">") else "")
        for match, g in itertools.groupby(
            body.replace("\r\n", "\n").splitlines(),
            lambda line: re.match(r"(?:\W+ |>)|$", line)
        )
    )
    # Remove leading whitespace when it is exactly one space
    body = re.sub(r"^ (?=\S)", "", body, flags=re.MULTILINE)
    body = re.sub(r"^>  (?=\S)", "> ", body, flags=re.MULTILINE)
    # Remove all trailing whitespace
    body = re.sub(r"^\S\s+$", "\1", body, flags=re.MULTILINE)

    return from_heading(heading, options["from"]) + textwrap.dedent(f"""\
                From: {eu.formataddr((name, address))}
                Date: {eu.format_datetime(timestamp)}
                Subject: {subject}
                \n""") + body

def format_issue(token, user, repo, number, options):
    issue = get_issue(token, user, repo, number, options)
    author = get_user(token, issue["author"]["login"])

    heading = f"{user}/{repo}#{number}"
    result = format_email(author["name"] or author["login"], author["email"],
                          isoparse(issue["createdAt"]), issue["title"],
                          issue["body"], options, heading)
    if not options["comments"]:
        return result
    return result + format_comments(issue["comments"]["nodes"],
                                    f"Re: {issue['title']}", options, heading)

def format_pr(token, user, repo, number, options):
    pr = get_pr(token, user, repo, number, options)
    request = requests.get(f"{pr['url']}.patch")
    if request.status_code != 200:
        print(f"{pr['url']}: fail with {request.status_code}", file=sys.stderr)

    heading = f"{user}/{repo}#{number}"
    result = from_heading(heading, options["from"])

    if not options["comments"]:
        return result
    return result + format_comments(pr["comments"]["nodes"],
                                    f"Re: {pr['title']}", options, heading)

def format_comments(comments, subject, options, heading="-"):
    result = ""
    for comment in comments:
        author = get_user(token, comment["author"]["login"])
        result += "\n\n" + format_email(
            author["name"] or author["login"], author["email"],
            isoparse(comment["createdAt"]), subject, comment["body"], options,
            heading
        )
    return result

if __name__ == "__main__":
    arguments = docopt(__doc__)
    matches = [(opt, re.match("--(\w+)", opt)) for opt in arguments.keys()]
    options = {match.group(1): arguments[opt]
               for opt, match in matches if match}

    try:
        load_dotenv()
    except NameError:
        pass
    token = os.getenv("HUBMAIL_TOKEN")
    if not token:
        print("No API token found. Have you set the HUBMAIL_TOKEN " +
              "environment variable?", file=sys.stderr)
        exit(1)

    if arguments["issue"]:
        print(format_issue(token, arguments["USER"], arguments["REPO"],
                           arguments["NUMBER"], options))
    if arguments["pr"]:
        print(format_pr(token, arguments["USER"], arguments["REPO"],
                        arguments["NUMBER"], options))
