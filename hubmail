#!/usr/bin/env python3
"""hubmail: a tool to export GitHub issues and pull requests as email messages

Usage:
  hubmail (issue|pr) [options] USER REPO NUMBER

Options:
  -c [N], --comments=[N]     Include the first N comments (if not specified, all
                             comments are included)
  -w [COLS], --wrap=[COLS]    Wrap lines of text to a certain number of columns
                              (default: 72)
"""
# SPDX-License-Identifier: LGPL-2.1-or-later

import sys
import os
import email.utils as eu
from time import time, gmtime, asctime
import textwrap
import itertools
import re

import requests
import argparse
from dateutil.parser import isoparse

try:
    from dotenv import load_dotenv
except ModuleNotFoundError:
    pass

def run_query(token, query):
    request = requests.post("https://api.github.com/graphql",
                            json={"query": query},
                            headers={"Authorization": f"Bearer {token}"})
    if request.status_code != 200:
        raise Exception(f"Query failed with {request.status_code}:\n{query}")
    result = request.json()

    if "errors" in result:
        raise Exception(result["errors"])
    else:
        return result

def get_issue(token, user, repo, number, options):
    cursor = None
    result = None
    num_comments = 0
    try:
        while options["comments"] is None or num_comments < options["comments"]:
            query = (f"""{{
            repository(owner:"{user}", name:"{repo}") {{
                issue(number:{number}) {{
                    title,
                    author {{
                        login,
                    }},
                    body,
                    createdAt,""" + (f"""
                    comments(
                            first:20""" +
                         (f', after:"{cursor}"' if cursor else "") +
                    f"""
                    ) {{
                        nodes {{
                            databaseId,
                            author {{
                                login,
                            }},
                            body,
                            createdAt,
                        }},
                        pageInfo {{
                            endCursor,
                        }},
                    }},
                    """ if options["comments"] != 0 else "") + f"""
                }},
            }},
            }}""")

            ## Issue
            queryResult = run_query(token, query)["data"]["repository"]["issue"]
            ## Issue!
            assert queryResult is not None

            if options["comments"] == 0:
                return queryResult
            elif not result:
                result = queryResult
            elif queryResult["comments"]["nodes"] is None:
                queryResult["comments"]["nodes"] = []
            else:
                result["comments"]["nodes"] += queryResult["comments"]["nodes"]

            num_comments += len(queryResult["comments"]["nodes"])
            if (options["comments"] is not None and
                    num_comments >= options["comments"]):
                # Trim to proper number of comments
                ## [IssueComment]!
                result["comments"]["nodes"] = (
                    result["comments"]["nodes"][:options["comments"]])
                ## Issue!
                return result

            ## String
            cursor = queryResult["comments"]["pageInfo"]["endCursor"]
            if not cursor:
                ## Issue!
                return result
    except Exception as e:
        print(f"{e}\n{query}", file=sys.stderr)
        sys.exit(1)

def get_pr(token, user, repo, number, options):
    cursor = None
    result = None
    num_comments = 0
    try:
        while options["comments"] is None or num_comments < options["comments"]:
            query = (f"""{{
            repository(owner:"{user}", name:"{repo}") {{
                pullRequest(number:{number}) {{
                    url,""" + (f"""
                    title,
                    comments(
                            first:20""" +
                         (f', after:"{cursor}"' if cursor else "") +
                    f"""
                    ) {{
                        nodes {{
                            databaseId,
                            author {{
                                login,
                            }},
                            body,
                            createdAt,
                        }},
                        pageInfo {{
                            endCursor,
                        }},
                    }},
                    """ if options["comments"] != 0 else "") + f"""
                }},
            }},
            }}""")

            ## PullRequest
            queryResult = run_query(
                token, query)["data"]["repository"]["pullRequest"]
            ## PullRequest!
            assert queryResult is not None

            if options["comments"] == 0:
                return queryResult
            elif not result:
                result = queryResult
            elif queryResult["comments"]["nodes"] is None:
                queryResult["comments"]["nodes"] = []
            else:
                result["comments"]["nodes"] += queryResult["comments"]["nodes"]

            num_comments += len(queryResult["comments"]["nodes"])
            if (options["comments"] is not None and
                    num_comments >= options["comments"]):
                # Trim to proper number of comments
                ## [IssueComment]!
                result["comments"]["nodes"] = (
                    result["comments"]["nodes"][:options["comments"]])
                ## PullRequest!
                return result

            ## String
            cursor = queryResult["comments"]["pageInfo"]["endCursor"]
            if not cursor:
                ## PullRequest!
                return result
    except Exception as e:
        print(f"{e}\n{query}", file=sys.stderr)
        sys.exit(1)

def get_user(token, login):
    query = f"""{{
    user(login:"{login}") {{
        login,
        name,
        email
    }}
    }}"""
    try:
        ## User
        result = run_query(token, query)["data"]["user"]
        if result is not None:
            ## User!
            return result
        else:
            ## {login, name, email}!
            return {"login": login, "name": login, "email": ""}
    except Exception as e:
        # TODO handle Organization
        ## {login, name, email}!
        return {"login": login, "name": login, "email": ""}

def format_email(name, address, timestamp, subject, body, options,
                 heading, message_id=None, in_reply_to=None, references=None):
    if references is None and in_reply_to is not None:
        references = [in_reply_to]

    body = body.replace("\r\n", "\n")

    try:
        cols = int(options["wrap"])
    except ValueError:
        cols = 0
    if cols > 0:
        body = "\n".join(
            textwrap.fill(
                line, cols, expand_tabs=False, replace_whitespace=False,
                break_long_words=False, break_on_hyphens=False,
                subsequent_indent=(
                    "> " if line.startswith("> ")
                    else ">" if line.startswith(">")
                    else ""))
            for line in body.splitlines())

    # Replace "From" at the beginning of a line with ">From";
    # include any quoting so that this process is reversible.
    body = re.sub(r"^([> ]*)From", r">\1From", body, flags=re.MULTILINE)

    return (
        textwrap.dedent(f"""\
            From nobody@localhost {asctime(gmtime(time()))}
            From: {eu.formataddr((name, address))}
            Date: {eu.format_datetime(timestamp)}
            Subject: {subject}
            Content-Type: text/plain; charset=UTF-8
            """)
        + (f"Message-ID: <{message_id}>\n" if message_id else "")
        + (f"In-Reply-To: <{in_reply_to}>\n" if in_reply_to else "")
        + (f"References: <{', '.join(references)}>\n" if references else "")
        + "\n" + body)

def format_issue(token, user, repo, number, options):
    ## Issue!
    issue = get_issue(token, user, repo, number, options)
    ## User! | {login, name, email}!
    author = get_user(token, issue["author"]["login"])

    result = format_email(author["name"] or author["login"], author["email"],
                          isoparse(issue["createdAt"]), issue["title"],
                          issue["body"], options, f"{user}/{repo}#{number}",
                          f"{user}/{repo}/issues/{number}@github.com")
    if options["comments"] == 0:
        return result
    return result + format_comments(
        ## [IssueComment]!
        issue["comments"]["nodes"], f"Re: {issue['title']}", options,
        (user, repo, "issues", str(number)))

def format_pr(token, user, repo, number, options):
    ## PullRequest!
    pr = get_pr(token, user, repo, number, options)
    request = requests.get(f"{pr['url']}.patch")
    if request.status_code != 200:
        print(f"{pr['url']}: fail with {request.status_code}", file=sys.stderr)

    thread_info = (user, repo, "pull", str(number))
    result = re.sub(r"(\nSubject: .*\n)", r"\1"
                    + f"Message-ID: <{'/'.join(thread_info)}@github.com>\n",
                    request.text)

    if options["comments"] == 0:
        return result
    return result + format_comments(
        ## [IssueComment]!
        pr["comments"]["nodes"], f"Re: {pr['title']}", options, thread_info)

def format_comments(comments, subject, options, thread_info):
    ## comments: [IssueComment]!

    user, repo, _, number = thread_info
    thread_name = f"{user}/{repo}#{number}"

    result = ""
    orig_message_id = f"{'/'.join(thread_info)}@github.com"
    for comment in comments:
        ## User! | {login, name, email}!
        author = get_user(token, comment["author"]["login"])
        message_id = f"{'/'.join(thread_info)}/c{comment['databaseId']}@github.com"
        result += "\n\n" + format_email(
            author["name"] or author["login"], author["email"],
            isoparse(comment["createdAt"]), subject, comment["body"], options,
            thread_name, message_id, orig_message_id)
    return result

if __name__ == "__main__":
    parser = argparse.ArgumentParser(
        description=textwrap.dedent(f"""\
            %(prog)s: Export GitHub issues and pull requests as email messages.
            The output is in mbox format as specified in RFC 4155.
            """))
    parser.add_argument(
        "type", choices=("issue", "pr"),
        help="Whether to fetch an issue or a pull request")
    parser.add_argument(
        "user", metavar="USER",
        help="The username of the owner of the repository")
    parser.add_argument(
        "repo", metavar="REPO",
        help="The name of the repository")
    parser.add_argument(
        "number", metavar="NUMBER", type=int,
        help="The number of the issue or pull request")
    parser.add_argument(
        "-c", "--comments", metavar="N", type=int, nargs='?', default=0,
        const=None,
        help=textwrap.dedent("""\
            Include the first %(metavar)s comments
            [default: all comments if -c provided]
            """))
    parser.add_argument(
        "-w", "--wrap", metavar="COLS", type=int, nargs='?', const=72,
        help=textwrap.dedent("""\
            Wrap each line of text to %(metavar)s columns
            [default: 72 if -w provided]
            """))
    args = vars(parser.parse_args())

    try:
        load_dotenv()
    except NameError:
        pass
    token = os.getenv("HUBMAIL_TOKEN")
    if not token:
        print("No API token found. Have you set the HUBMAIL_TOKEN " +
              "environment variable?", file=sys.stderr)
        exit(1)

    if args["type"] == "issue":
        print(format_issue(token, args["user"], args["repo"],
                           args["number"], args))
    elif args["type"] == "pr":
        print(format_pr(token, args["user"], args["repo"],
                        args["number"], args))
